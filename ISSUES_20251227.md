# 영상 생성 문제 및 개선 계획 (2025-12-27)

## 📋 발견된 문제 (총 6개)

### 1. 자막이 짤려서 보이는 증상
**현상**: 자막 텍스트가 박스를 벗어나 일부가 잘림
**원인**: TextClip의 size 설정이 텍스트 길이를 고려하지 않음
**영향도**: 🔴 High - 가독성 치명적

**로그 분석**:
```
[Editor] 자막 9개 추가 완료
```
- 자막은 생성되었으나 크기 계산 오류

### 2. 제목의 가로폭이 너무 좁음
**현상**: 제목이 상단 검은 배경에 너무 좁게 표시됨
**원인**: `size=(int(width * 0.8), None)` - 80%로 제한
**영향도**: 🟡 Medium - 시각적 불균형

**현재 설정**:
```python
size=(int(width * 0.8), None)  # 1080 * 0.8 = 864px
```

### 3. TTS 자막 싱크 미일치
**현상**:
- 자막이 한줄로만 보이지 않고 여러줄로 표시
- TTS 발음과 자막 타이밍이 맞지 않음

**원인**:
- 줄바꿈 로직이 세그먼트 무시하고 전체 텍스트를 18자로 나눔
- 세그먼트별 duration과 자막 표시 시간이 정확히 매핑되지 않음

**영향도**: 🔴 High - 사용자 경험 저하

**로그 분석**:
```
[Planner] 총 세그먼트 시간: 65.5초 / 목표: 60초
[Editor] 오디오 로드: 62.69초
```
- 세그먼트 9개가 생성되었으나 자막은 세그먼트별로 표시되지 않음

### 4. 배경음악이 들리지 않음 (자동/수동 둘다)
**현상**: BGM이 전혀 재생되지 않음

**원인**:
1. BGM 카탈로그 파일 없음
2. BGM 파일이 music 폴더에 없음
3. pydub 패키지 미설치로 길이 측정 실패

**영향도**: 🟡 Medium - 영상 품질 저하

**로그 분석**:
```
[BGMManager] 카탈로그 파일 없음: assets\music\catalog.json
[WARNING] pydub 패키지가 설치되지 않았습니다. 예상 길이를 사용합니다.
[BGM] 추론된 분위기: energetic (주제: 인싸 신조어 챌린지! 과연 성공?)
[BGMManager] energetic BGM 없음 (min_duration=60)
[BGM] energetic 분위기의 BGM이 없습니다. 랜덤 선택 시도...
[SUCCESS] 에셋 수집 완료: 영상 9개, 음성 1개, BGM 0개
```

### 5. 영상 길이 제어 실패
**현상**: 30초로 지정했으나 실제 60~70초로 생성됨

**원인**:
- TTS 오디오 길이가 목표 길이를 무시함
- `[Editor] 실제 TTS 오디오 길이 사용: 62.69초`

**영향도**: 🔴 High - 사용자 요구사항 무시

**로그 분석**:
```
[Planner] 총 세그먼트 시간: 65.5초 / 목표: 60초
[Planner] 시간 차이 5.5초 감지. 세그먼트 조정 중...
[Planner] 조정 후 총 시간: 60.0초
...
[Editor] 오디오 로드: 62.69초
[Editor] 실제 TTS 오디오 길이 사용: 62.69초
[Editor] 최종 목표 길이: 62.69초
```
- Planner는 60초로 조정했으나, Editor가 TTS 실제 길이(62.69초)로 덮어씀

### 6. Typecast TTS 미지원
**현상**: Typecast API가 .env에 있으나 사용 불가

**요구사항**:
- Typecast TTS 프로바이더 추가
- 프론트엔드 UI에서 선택 가능하도록 구현

**영향도**: 🟢 Low - 새 기능 추가

---

## 🐛 에러 로그 분석

### 1. Pixabay API 키 설정 오류
```
[ERROR] Pixabay API 오류: 400 Client Error: Bad Request for url:
https://pixabay.com/api/videos/?key=your_pixabay_api_key_here&q=...
```
**원인**: `.env` 파일의 PIXABAY_API_KEY가 기본값으로 설정됨
**해결**: 실제 API 키로 교체 또는 Pixabay 비활성화

### 2. BGM 카탈로그 파일 없음
```
[BGMManager] 카탈로그 파일 없음: assets\music\catalog.json
```
**원인**: music 폴더 구조 변경 (assets → music)
**해결**: 카탈로그 자동 생성 또는 경로 수정

### 3. pydub 패키지 미설치
```
[WARNING] pydub 패키지가 설치되지 않았습니다. 예상 길이를 사용합니다.
```
**원인**: requirements.txt에 pydub 누락
**해결**: `pip install pydub` 및 ffmpeg 설치

### 4. Pexels 비디오 파싱 실패
```
[ERROR] Pexels 비디오 파싱 실패: 'NoneType' object has no attribute 'lower'
```
**원인**: Pexels API 응답의 일부 비디오 메타데이터 누락
**해결**: None 체크 추가

### 5. Python 3.14 호환성 경고
```
UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
```
**원인**: ElevenLabs SDK가 Pydantic V1 사용
**해결**: ElevenLabs SDK 업데이트 또는 Python 다운그레이드

---

## 📝 Phase별 수정 계획

### Phase 1: 자막 시스템 완전 재설계 (우선순위: 🔴 High)
**목표**: TTS 세그먼트별 자막 표시, 자막 짤림 해결

**수정 파일**:
- `core/editor.py` - `_add_subtitles()` 메서드 전면 수정

**수정 내용**:
1. ✅ 세그먼트별로 자막 생성 (현재 로직 유지)
2. ✅ 텍스트 박스 크기를 `None`으로 설정하여 자동 크기 조정
3. ✅ `method='caption'` → `method='label'`로 변경 (자동 크기)
4. ✅ 줄바꿈을 세그먼트 텍스트 그대로 사용 (18자 강제 분할 제거)
5. ✅ 각 세그먼트의 start_time과 duration을 정확히 매핑

**예상 코드 변경**:
```python
# 이전
txt_clip = self.TextClip(
    text=self._wrap_text(text, max_chars=18),  # 강제 줄바꿈
    method='caption',
    size=(int(self.config.resolution[0] * 0.9), None)
)

# 수정 후
txt_clip = self.TextClip(
    text=text,  # 세그먼트 텍스트 그대로
    method='label',  # 자동 크기
    size=None  # 자동 조정
)
```

### Phase 2: 제목 가로폭 조정 (우선순위: 🟡 Medium)
**목표**: 제목을 상단 배경 전체 폭에 맞게 표시

**수정 파일**:
- `core/editor.py` - `_apply_shorts_layout()` 메서드

**수정 내용**:
1. ✅ 제목 폭을 80% → 90%로 증가
2. ✅ 제목 폰트 크기를 55px → 60px로 증가
3. ✅ 제목 줄바꿈 기준을 10자 → 15자로 조정

**예상 코드 변경**:
```python
# 이전
size=(int(width * 0.8), None)  # 80%
font_size=55

# 수정 후
size=(int(width * 0.9), None)  # 90%
font_size=60
```

### Phase 3: BGM 시스템 수정 (우선순위: 🟡 Medium)
**목표**: BGM이 정상적으로 재생되도록 수정

**수정 파일**:
- `core/bgm_manager.py` - 카탈로그 경로 수정
- `requirements.txt` - pydub 추가
- `music/` 폴더 구조 정리

**수정 내용**:
1. ✅ pydub 및 ffmpeg 설치 가이드 추가
2. ✅ 카탈로그 경로를 `music/` 폴더로 변경
3. ✅ 카탈로그가 없을 때 자동 생성 로직 추가
4. ✅ BGM 볼륨 기본값 조정 (0.3 → 0.2)
5. ✅ BGM이 없을 때 무음으로 처리 (에러 방지)

**설치 필요**:
```bash
pip install pydub
# Windows: ffmpeg 설치 필요
```

### Phase 4: 영상 길이 제어 수정 (우선순위: 🔴 High)
**목표**: 사용자가 지정한 길이로 정확히 생성

**수정 파일**:
- `core/planner.py` - 세그먼트 길이 조정 강화
- `core/editor.py` - TTS 길이를 목표 길이로 강제

**수정 내용**:
1. ✅ Planner가 목표 길이(30초)로 세그먼트 생성
2. ✅ TTS 생성 시 목표 길이 초과하면 텍스트 단축
3. ✅ Editor가 TTS 실제 길이를 무시하고 목표 길이 사용
4. ✅ 비디오 클립을 목표 길이에 정확히 맞춤

**예상 코드 변경**:
```python
# editor.py
# 이전
final_duration = audio_clip.duration  # TTS 실제 길이 사용

# 수정 후
final_duration = content_plan.target_duration  # 목표 길이 강제
if audio_clip and audio_clip.duration > final_duration:
    audio_clip = audio_clip.subclipped(0, final_duration)  # 자르기
```

### Phase 5: Typecast TTS 추가 (우선순위: 🟢 Low)
**목표**: Typecast TTS 프로바이더 추가

**수정 파일**:
- `providers/tts/typecast.py` - 새 파일 생성
- `core/asset_manager.py` - Typecast 통합
- `frontend/components/TTSSettings.tsx` - UI 추가

**수정 내용**:
1. ✅ Typecast API 클라이언트 구현
2. ✅ AssetManager에 Typecast 프로바이더 추가
3. ✅ 프론트엔드에서 Typecast 선택 가능하도록 UI 추가
4. ✅ Typecast Voice 목록 API 연동

**Typecast API 참고**:
- 공식 문서: https://typecast.ai/docs/api
- 인증: Bearer Token

### Phase 6: 에러 수정 및 최적화 (우선순위: 🟢 Low)
**목표**: 로그에 나타난 에러 및 경고 제거

**수정 파일**:
- `providers/stock/pixabay.py` - API 키 검증 추가
- `providers/stock/pexels.py` - None 체크 추가
- `requirements.txt` - 패키지 업데이트

**수정 내용**:
1. ✅ Pixabay API 키 검증 (없으면 비활성화)
2. ✅ Pexels 비디오 파싱 시 None 체크 강화
3. ✅ pydub를 requirements.txt에 추가
4. ✅ ElevenLabs SDK 업데이트 (Pydantic V2 호환)
5. ✅ 에러 로그 개선 (더 명확한 메시지)

---

## 🎯 작업 우선순위

### 🔴 즉시 수정 필요 (High Priority)
1. **Phase 1**: 자막 시스템 재설계 - 자막 짤림, 싱크 문제
2. **Phase 4**: 영상 길이 제어 - 사용자 요구사항 무시

### 🟡 조만간 수정 (Medium Priority)
3. **Phase 2**: 제목 가로폭 조정
4. **Phase 3**: BGM 시스템 수정

### 🟢 여유 있을 때 (Low Priority)
5. **Phase 5**: Typecast TTS 추가
6. **Phase 6**: 에러 수정 및 최적화

---

## 📊 예상 작업 시간

| Phase | 예상 시간 | 난이도 |
|-------|----------|--------|
| Phase 1 | 30분 | ⭐⭐⭐ |
| Phase 2 | 10분 | ⭐ |
| Phase 3 | 20분 | ⭐⭐ |
| Phase 4 | 25분 | ⭐⭐⭐ |
| Phase 5 | 40분 | ⭐⭐⭐⭐ |
| Phase 6 | 15분 | ⭐⭐ |
| **총합** | **2시간 20분** | - |

---

## 📌 다음 단계

1. 이 문서를 검토하고 Phase 순서 확인
2. Phase 1부터 순차적으로 수정 시작
3. 각 Phase 완료 후 테스트 영상 생성
4. 모든 Phase 완료 후 최종 통합 테스트

---

**작성일**: 2025-12-27
**작성자**: Claude Code
**버전**: v4.0
